"use strict";define(["jquery","underscore","api/SplunkVisualizationBase","api/SplunkVisualizationUtils","enterpriseAttack","icsAttack","mobileAttack","d3fend"],(function(t,a,e,r,n,i,c,s){return e.extend({initialize:function(){e.prototype.initialize.apply(this,arguments),this.$el=t(this.el),this.animate=!1,this.$el.addClass("mitre-container"),this.colorMap=[{pct:0,color:{r:99,g:190,b:123}},{pct:50,color:{r:255,g:213,b:132}},{pct:100,color:{r:248,g:105,b:107}}]},formatData:function(t){if(t.rows.length<1)return!1;if(t.rows[0].length<2)throw new e.VisualizationError("Search results must have at least 2 fields: id, count");return t},updateView:function(a,e){if(a){this.$el.empty();var o=this,l=this.colorMap,d=r.normalizeBoolean(e[this.getPropertyNamespaceInfo().propertyNamespace+"animate"]||"no"),m=e[this.getPropertyNamespaceInfo().propertyNamespace+"duration"]||300,p=r.getCurrentTheme(),u=e[this.getPropertyNamespaceInfo().propertyNamespace+"startColor"]||"#53a051",h=e[this.getPropertyNamespaceInfo().propertyNamespace+"midColor"]||"#f8be34",v=e[this.getPropertyNamespaceInfo().propertyNamespace+"endColor"]||"#dc4e41",f=e[this.getPropertyNamespaceInfo().propertyNamespace+"startVal"]||0,g=e[this.getPropertyNamespaceInfo().propertyNamespace+"endVal"]||100,b=e[this.getPropertyNamespaceInfo().propertyNamespace+"display"]||"id",_=r.escapeHtml(e[this.getPropertyNamespaceInfo().propertyNamespace+"legendTitle"])||a.fields[1].name,q=e[this.getPropertyNamespaceInfo().propertyNamespace+"sortKey"]||"data-id",y=e[this.getPropertyNamespaceInfo().propertyNamespace+"sortOrder"]||"asc",N=r.normalizeBoolean(e[this.getPropertyNamespaceInfo().propertyNamespace+"hideNull"]||"no"),w=r.normalizeBoolean(e[this.getPropertyNamespaceInfo().propertyNamespace+"showSubTechniques"]||"yes"),k=(e[this.getPropertyNamespaceInfo().propertyNamespace+"matrix"]||"enterprise::").split("::"),C=k[0],I=k[1].split(","),x={};o.animate=d,x="ics"==C?i:"mobile"==C?c:"d3fend"==C?s:n,this.$el.attr("class","").addClass(p),l[0].color=this._hexToRgb(u),l[1].color=this._hexToRgb(h),l[2].color=this._hexToRgb(v);var P=t('<div class="mtr-viz-container"></div>'),T=t('\n            <div class="mtr-legend">\n                <div class="mtr-legend-title">'+_+'</div>\n                <div class="mtr-legend-meter-container">    \n                    <div class="mtr-legend-meter"></div>\n                </div>\n                <div class="mtr-legend-val">\n                    <span>'+f+"</span>\n                    <span>"+(g-f)/2+"</span>\n                    <span>"+g+"</span>\n                </div>\n            </div>\n        "),M="(45deg, "+u+" 0%, "+h+" 50%, "+v+" 100%)";t(".mtr-legend-meter",T).css("background","-moz-linear-gradient"+M).css("background","-webkit-linear-gradient"+M).css("background","linear-gradient"+M),T.hover((function(){t(".mtr-legend-meter-container",this).append(t('<div class="mtr-legend-cursor"></div'))}),(function(){t(".mtr-legend-cursor").remove(),t(".mtr-technique").removeClass("focused").removeClass("defocused")}));if(T.mousemove((function(a){if(a.preventDefault(),Date.now()>100){var e=t(".mtr-legend-cursor",this),r=e.width(),n=t(this).width(),i=a.pageX-t(this).offset().left;if(i<=n&&i>0){var c=i-r/2;e.css("left",c+"px");var s=c/n*(g-f),l=(c+r)/n*(g-f);o._setAnimationClass(s,l)}}})),x.tactics.forEach((function(a){$tactic_col=t('<div class="mtr-tactic-col" data-id="'.concat(a.id,'" data-name="').concat(a.name,'" data-tactic="').concat(a.short_name,'">')),$tactic_col.appendTo(P).append('\n                    <div class="mtr-tactic">\n                        <div class="mtr-tactic-title">'.concat(a.name,'</div>\n                        <div class="mtr-meter-container">\n                            <div class="mtr-meter-fill"></div>\n                        </div>\n                        <div class="grid-wrapper">\n                            <div class="mtr-stats-container">\n                                <div class="mtr-total mtr-stat">\n                                    <div class="mtr-stats-label">Total</div>\n                                    <div class="mtr-stats-val"></div>\n                                </div>\n                                <div class="mtr-count mtr-stat">\n                                    <div class="mtr-stats-label">Unique Techniques</div>\n                                    <div class="mtr-stats-val"></div>\n                                </div>\n                                <div class="mtr-mean mtr-stat">\n                                    <div class="mtr-stats-label">Average per Technique</div>\n                                    <div class="mtr-stats-val"></div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class="mtr-technique-col"></div>\n            ')),t(".mtr-tactic-title",P).click((function(a){drilldown_data={mtr_tactic:t(this).parents(".mtr-tactic-col").attr("data-name")},o._drilldown(drilldown_data,a)}))})),x.techniques.forEach((function(a){if(""==I||!("platform"in a)||I.some((function(t){return a.platform.indexOf(t)>=0}))){var e="id"==b?a.id:a.name,r=t('\n                <div class="mtr-technique-container mtr-display-'.concat(b,'" data-id="').concat(a.id,'">\n                    <div class="mtr-technique" data-id="').concat(a.id,'" data-name="').concat(a.name,'" data-url="').concat(a.url,'">\n                        <span>').concat(e,'</span>\n                    </div>\n                    <div class="mtr-sub-technique-container mtr-display-').concat(b,'"></div>\n                </div>\n            '));a.tactics.forEach((function(a){r.clone().prependTo(t('.mtr-tactic-col[data-tactic="'.concat(a,'"] .mtr-technique-col'),P))}))}})),w&&x.sub_techniques.forEach((function(a){if(""==I||!("platform"in a)||I.some((function(t){return a.platform.indexOf(t)>=0}))){var e="id"==b?a.short_id:a.name;t('.mtr-technique-container[data-id="'.concat(a.technique,'"]'),P).each((function(){t(".mtr-sub-technique-container",t(this)).append('\n                        <div class="mtr-sub-technique mtr-display-'.concat(b,'" data-id="').concat(a.id,'" data-name="').concat(a.name,'" data-url="').concat(a.url,'">\n                            <span>').concat(e,"</span>\n                        </div>\n                    "))}))}})),a.rows.forEach((function(a){var e=r.escapeHtml(a[0]),n=r.escapeHtml(a[1]),i=t('.mtr-technique[data-id="'.concat(e,'"], .mtr-sub-technique[data-id="').concat(e,'"]'),P);if(i&&n&&""!=n&&null!=n&&!isNaN(n)){var c=o._getPercent(f,g,n),s=o._getColor(c),l=r.escapeHtml(a[2])||"";c<2&&(c=2),i.attr("data-value",n),i.attr("data-percent",c),i.attr("data-desc",l),i.css("background",s.background).css("color",s.foreground)}})),t(".mtr-technique, .mtr-sub-technique",P).hover((function(e){var r=t(this).attr("data-id"),n=t(this).attr("data-name"),i=parseInt(t(this).attr("data-percent"))||"",c=t(this).attr("data-desc")||"",s=parseInt(t(this).attr("data-value"))||"",l=t(this).attr("data-url")||"",d=o._getColor(i);i<2&&(i=2);var m=t('\n                <div class="mtr-technique-tooltip">\n                    <div class="mtr-id">'.concat(r,'</div>\n                    <div class="mtr-name">').concat(n,'</div>\n                    <div class="mtr-meter-container">\n                        <div class="mtr-meter-fill"></div>\n                    </div>\n                    <div class="mtr-label"></div>\n                    <div class="mtr-val">').concat(s,'</div>\n                    <div class="mtr-desc"></div>\n                    <div class="mtr-ref"><a target="_blank" href="').concat(l,'">').concat(l,' <i class="icon-external"></i></a></div>\n                </div>\n            '));t(this).offset().left>t(window).width()-400?m.addClass("mtr-technique-tooltip-left"):m.addClass("mtr-technique-tooltip-right");var p="",u=256;if(c.length>u){var h=c.substr(0,u),v=c.substr(u,c.length-u);h=h.split("\\n").join("</p><p>"),v=v.split("\\n").join("</p><p>"),p="<p>".concat(h,' <span class="more-elipses">...</span><span class="more-content">').concat(v,'</span><a href="#" class="more-link">Show more</a></p>')}else p=c.split("\\n").join("</p><p>");t(".mtr-desc",m).append(p),t(".more-link",m).click((function(){return t(".more-elipses",m).hide(),t(".more-content",m).show(),t(".more-link",m).hide(),!1})),m.appendTo(t(this)),s&&(t(".mtr-label",m).text(a.fields[1].name),t(".mtr-meter-fill",m).css("background",d.background).animate({width:t(this).attr("data-percent")+"%"},50,"linear"),d.luminance<.1&&t(".mtr-meter-container",m).addClass("dark"))}),(function(){t(".mtr-technique-tooltip").remove()})),t(".mtr-tactic-col",P).each((function(){var a=0,e=0,r=0;if(t(".mtr-technique",this).each((function(){var n=t(this).attr("data-value");n||!N?(r+=1,n&&!isNaN(n)&&(a+=+n,e+=1)):t(this).parent().remove()})),0==r&&N)t(this).remove();else{var n=Math.round(a/e),i=Math.round(e/r*100);n||(n=0),i||(i=0);var c=o._getPercent(f,g,n),s=o._getColor(c);c<2&&(c=2),t(this).attr("data-value",a),t(".mtr-tactic .mtr-meter-fill",this).css("background",s.background).css("color",s.foreground).css("width",c+"%"),t(".mtr-tactic .mtr-stat",this).css("background",s.background).css("color",s.foreground).css("border-color",s.foreground),t(".mtr-tactic .mtr-total .mtr-stats-val",this).text(a.toLocaleString()),t(".mtr-tactic .mtr-count .mtr-stats-val",this).text(e.toLocaleString()+" (".concat(i,"%)")),t(".mtr-tactic .mtr-mean .mtr-stats-val",this).text(n.toLocaleString())}})),t(".mtr-technique, .mtr-sub-technique, .mtr-tactic",P).each((function(){t(this).click((function(a){var e=t(this).closest(".mtr-tactic-col"),r=t(this).closest(".mtr-technique-container"),n=t(".mtr-technique",r),i=t(this).closest(".mtr-sub-technique"),c={};c["mtr_sub-technique_id"]=i.attr("data-id"),c.mtr_technique_id=n.attr("data-id"),c.mtr_tactic_id=e.attr("data-id"),c["mtr_sub-technique_name"]=i.attr("data-name"),c.mtr_technique_name=n.attr("data-name"),c.mtr_tactic_name=e.attr("data-name"),c["mtr_sub-technique_value"]=i.attr("data-value"),c.mtr_technique_value=n.attr("data-value"),c.mtr_tactic_value=e.attr("data-value"),o._drilldown(c,a)}))})),t(".mtr-technique-col",P).each((function(){o._sortElements(t(this),q,y),t(this).append('\n                <div class="mtr-technique-container mtr-placeholder mtr-display-'.concat(b,'">\n                    <div class="mtr-technique mtr-display-').concat(b,'">\n                        <div class="mtr-technique-title">T0000</div>\n                    </div>\n                </div>\n                <div class="mtr-technique-container mtr-placeholder mtr-display-').concat(b,'">\n                    <div class="mtr-technique mtr-placeholder mtr-display-').concat(b,'">\n                        <div class="mtr-technique-title">T0000</div>\n                    </div>\n                </div>\n            '))})),P.appendTo(this.$el),T.appendTo(this.$el),o.animate){var V=(g-f)/m/60,A=.1*(g-f),E=0;window.requestAnimationFrame((function a(){var e=E,r=e+V+A;o._setAnimationClass(e,r),e<g?E+=V:E=0,o.animate?window.requestAnimationFrame(a):t(".mtr-technique").removeClass("focused").removeClass("defocused")}))}}},getInitialDataParams:function(){return{outputMode:e.ROW_MAJOR_OUTPUT_MODE}},reflow:function(){},_setAnimationClass:function(a,e){t(".mtr-technique").each((function(){var r=t(this).attr("data-value");r&&r>=a&&r<=e?t(this).addClass("focused").removeClass("defocused"):t(this).removeClass("focused").addClass("defocused")}))},_getPercent:function(t,a,e){var r=Math.round(100*(e-t)/(a-t));return r>100&&(r=100),r<0&&(r=0),r},_hexToRgb:function(t){var a=0,e=0,r=0;return 4==t.length?(a="0x"+t[1]+t[1],e="0x"+t[2]+t[2],r="0x"+t[3]+t[3]):7==t.length&&(a="0x"+t[1]+t[2],e="0x"+t[3]+t[4],r="0x"+t[5]+t[6]),{r:a,g:e,b:r}},_getColor:function(t){for(var a=1;a<this.colorMap.length-1&&!(t<this.colorMap[a].pct);a++);var e=this.colorMap[a-1],r=this.colorMap[a],n=r.pct-e.pct,i=(t-e.pct)/n,c=1-i,s=i,o={r:Math.floor(e.color.r*c+r.color.r*s),g:Math.floor(e.color.g*c+r.color.g*s),b:Math.floor(e.color.b*c+r.color.b*s)},l=(.299*o.r+.587*o.g+.114*o.b)/255,d=l>.65?"rgb(0,0,0)":"rgb(255,255,255)";return{background:"rgb("+[o.r,o.g,o.b].join(",")+")",luminance:l,foreground:d}},_sortElements:function(a,e,r){var n="asc"==r?1:-1;$children=a.children().sort((function(a,r){var i=t(".mtr-technique",t(a)),c=t(".mtr-technique",t(r));return"data-id"==e||"data-name"==e?n*(i.attr(e)<c.attr(e)?-1:1):"data-value"==e?(aVal=parseInt(i.attr(e)),bVal=parseInt(c.attr(e)),Number.isInteger(aVal)||(aVal=-1),Number.isInteger(bVal)||(bVal=-1),n*(aVal<bVal?-1:1)):0})),a.append($children)},_drilldown:function(t,a){this.drilldown({action:e.FIELD_VALUE_DRILLDOWN,data:t},a)}})}));