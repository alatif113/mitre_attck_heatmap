"use strict";define(["jquery","underscore","api/SplunkVisualizationBase","api/SplunkVisualizationUtils","enterpriseAttack","icsAttack","mobileAttack","d3fend"],(function(t,e,a,r,n,i,s,c){return a.extend({initialize:function(){a.prototype.initialize.apply(this,arguments),this.$el=t(this.el),this.animate=!1,this.$el.addClass("mitre-container"),this.colorMap=[{pct:0,color:{r:99,g:190,b:123}},{pct:50,color:{r:255,g:213,b:132}},{pct:100,color:{r:248,g:105,b:107}}]},formatData:function(t){if(t.rows.length<1)return!1;if(t.rows[0].length<2)throw new a.VisualizationError("Search results must have at least 2 fields: id, count");return t},updateView:function(e,a){if(e){this.$el.empty();var o=this,l=this.colorMap,d=r.normalizeBoolean(a[this.getPropertyNamespaceInfo().propertyNamespace+"animate"]||"no"),m=a[this.getPropertyNamespaceInfo().propertyNamespace+"duration"]||300,u=r.getCurrentTheme(),p=a[this.getPropertyNamespaceInfo().propertyNamespace+"startColor"]||"#53a051",h=a[this.getPropertyNamespaceInfo().propertyNamespace+"midColor"]||"#f8be34",v=a[this.getPropertyNamespaceInfo().propertyNamespace+"endColor"]||"#dc4e41",f=a[this.getPropertyNamespaceInfo().propertyNamespace+"startVal"]||0,g=a[this.getPropertyNamespaceInfo().propertyNamespace+"endVal"]||100,b=a[this.getPropertyNamespaceInfo().propertyNamespace+"display"]||"id",q=r.escapeHtml(a[this.getPropertyNamespaceInfo().propertyNamespace+"legendTitle"])||e.fields[1].name,_=a[this.getPropertyNamespaceInfo().propertyNamespace+"sortKey"]||"data-id",y=a[this.getPropertyNamespaceInfo().propertyNamespace+"sortOrder"]||"asc",N=r.normalizeBoolean(a[this.getPropertyNamespaceInfo().propertyNamespace+"hideNull"]||"no"),w=r.normalizeBoolean(a[this.getPropertyNamespaceInfo().propertyNamespace+"showSubTechniques"]||"yes"),C=r.normalizeBoolean(a[this.getPropertyNamespaceInfo().propertyNamespace+"showSearchBar"]||"yes"),k=(a[this.getPropertyNamespaceInfo().propertyNamespace+"matrix"]||"enterprise::").split("::"),I=k[0],x=k[1].split(","),T={};o.animate=d,T="ics"==I?i:"mobile"==I?s:"d3fend"==I?c:n,this.$el.attr("class","").addClass(u),l[0].color=this._hexToRgb(p),l[1].color=this._hexToRgb(h),l[2].color=this._hexToRgb(v);var P=t('\n            <div class="mtr-search-container">\n                <div class="splunk-textinput">\n                    <label for="mtrSearchInput">Technique ID/Name</label>\n                    <input id="mtrSearchInput" class="mtr-search-input" type="text"/>\n                </div>\n            </div>\n        '),M=t('<div class="mtr-viz-container"></div>'),V=t('\n            <div class="mtr-legend">\n                <div class="mtr-legend-title">'+q+'</div>\n                <div class="mtr-legend-meter-container">    \n                    <div class="mtr-legend-meter"></div>\n                </div>\n                <div class="mtr-legend-val">\n                    <span>'+f+"</span>\n                    <span>"+(g-f)/2+"</span>\n                    <span>"+g+"</span>\n                </div>\n            </div>\n        "),z="(45deg, "+p+" 0%, "+h+" 50%, "+v+" 100%)";t(".mtr-legend-meter",V).css("background","-moz-linear-gradient"+z).css("background","-webkit-linear-gradient"+z).css("background","linear-gradient"+z),V.hover((function(){t(".mtr-legend-meter-container",this).append(t('<div class="mtr-legend-cursor"></div'))}),(function(){t(".mtr-legend-cursor").remove(),t(".mtr-technique").removeClass("focused").removeClass("defocused")}));if(V.mousemove((function(e){if(e.preventDefault(),Date.now()>100){var a=t(".mtr-legend-cursor",this),r=a.width(),n=t(this).width(),i=e.pageX-t(this).offset().left;if(i<=n&&i>0){var s=i-r/2;a.css("left",s+"px");var c=s/n*(g-f),l=(s+r)/n*(g-f);o._setAnimationClass(c,l)}}})),T.tactics.forEach((function(e){$tactic_col=t('<div class="mtr-tactic-col" data-id="'.concat(e.id,'" data-name="').concat(e.name,'" data-tactic="').concat(e.short_name,'">')),$tactic_col.appendTo(M).append('\n                    <div class="mtr-tactic">\n                        <div class="mtr-tactic-title">'.concat(e.name,'</div>\n                        <div class="mtr-meter-container">\n                            <div class="mtr-meter-fill"></div>\n                        </div>\n                        <div class="grid-wrapper">\n                            <div class="mtr-stats-container">\n                                <div class="mtr-total mtr-stat">\n                                    <div class="mtr-stats-label">Total</div>\n                                    <div class="mtr-stats-val"></div>\n                                </div>\n                                <div class="mtr-count mtr-stat">\n                                    <div class="mtr-stats-label">Unique Techniques</div>\n                                    <div class="mtr-stats-val"></div>\n                                </div>\n                                <div class="mtr-mean mtr-stat">\n                                    <div class="mtr-stats-label">Average per Technique</div>\n                                    <div class="mtr-stats-val"></div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class="mtr-technique-col"></div>\n            ')),t(".mtr-tactic-title",M).click((function(e){drilldown_data={mtr_tactic:t(this).parents(".mtr-tactic-col").attr("data-name")},o._drilldown(drilldown_data,e)}))})),T.techniques.forEach((function(e){if(""==x||!("platform"in e)||x.some((function(t){return e.platform.indexOf(t)>=0}))){var a="id"==b?e.id:e.name,r=t('\n                <div class="mtr-technique-container mtr-display-'.concat(b,'" data-id="').concat(e.id,'">\n                    <div class="mtr-technique" data-id="').concat(e.id,'" data-name="').concat(e.name,'" data-url="').concat(e.url,'">\n                        <span>').concat(a,'</span>\n                    </div>\n                    <div class="mtr-sub-technique-container mtr-display-').concat(b,'"></div>\n                </div>\n            '));e.tactics.forEach((function(e){r.clone().prependTo(t('.mtr-tactic-col[data-tactic="'.concat(e,'"] .mtr-technique-col'),M))}))}})),w&&T.sub_techniques.forEach((function(e){if(""==x||!("platform"in e)||x.some((function(t){return e.platform.indexOf(t)>=0}))){var a="id"==b?e.short_id:e.name;t('.mtr-technique-container[data-id="'.concat(e.technique,'"]'),M).each((function(){t(".mtr-sub-technique-container",t(this)).append('\n                        <div class="mtr-sub-technique mtr-display-'.concat(b,'" data-id="').concat(e.id,'" data-name="').concat(e.name,'" data-url="').concat(e.url,'">\n                            <span>').concat(a,"</span>\n                        </div>\n                    "))}))}})),e.rows.forEach((function(e){var a=r.escapeHtml(e[0]),n=r.escapeHtml(e[1]),i=t('.mtr-technique[data-id="'.concat(a,'"], .mtr-sub-technique[data-id="').concat(a,'"]'),M);if(i&&n&&""!=n&&null!=n&&!isNaN(n)){var s=o._getPercent(f,g,n),c=o._getColor(s),l=r.escapeHtml(e[2])||"";s<2&&(s=2),i.attr("data-value",n),i.attr("data-percent",s),i.attr("data-desc",l),i.css("background",c.background).css("color",c.foreground)}})),t(".mtr-technique, .mtr-sub-technique",M).hover((function(a){var r=t(this).attr("data-id"),n=t(this).attr("data-name"),i=parseInt(t(this).attr("data-percent"))||"",s=t(this).attr("data-desc")||"",c=parseInt(t(this).attr("data-value"))||"",l=t(this).attr("data-url")||"",d=o._getColor(i);i<2&&(i=2);var m=t('\n                <div class="mtr-technique-tooltip">\n                    <div class="mtr-id">'.concat(r,'</div>\n                    <div class="mtr-name">').concat(n,'</div>\n                    <div class="mtr-meter-container">\n                        <div class="mtr-meter-fill"></div>\n                    </div>\n                    <div class="mtr-label"></div>\n                    <div class="mtr-val">').concat(c,'</div>\n                    <div class="mtr-desc"></div>\n                    <div class="mtr-ref"><a target="_blank" href="').concat(l,'">').concat(l,' <i class="icon-external"></i></a></div>\n                </div>\n            '));t(this).offset().left>t(window).width()-400?m.addClass("mtr-technique-tooltip-left"):m.addClass("mtr-technique-tooltip-right");var u="",p=256;if(s.length>p){var h=s.substr(0,p),v=s.substr(p,s.length-p);h=h.split("\\n").join("</p><p>"),v=v.split("\\n").join("</p><p>"),u="<p>".concat(h,' <span class="more-elipses">...</span><span class="more-content">').concat(v,'</span><a href="#" class="more-link">Show more</a></p>')}else u=s.split("\\n").join("</p><p>");t(".mtr-desc",m).append(u),t(".more-link",m).click((function(){return t(".more-elipses",m).hide(),t(".more-content",m).show(),t(".more-link",m).hide(),!1})),m.appendTo(t(this)),c&&(t(".mtr-label",m).text(e.fields[1].name),t(".mtr-meter-fill",m).css("background",d.background).animate({width:t(this).attr("data-percent")+"%"},50,"linear"),d.luminance<.1&&t(".mtr-meter-container",m).addClass("dark"))}),(function(){t(".mtr-technique-tooltip").remove()})),t(".mtr-tactic-col",M).each((function(){var e=0,a=0,r=0;if(t(".mtr-technique",this).each((function(){var n=t(this).attr("data-value");n||!N?(r+=1,n&&!isNaN(n)&&(e+=+n,a+=1)):t(this).parent().remove()})),0==r&&N)t(this).remove();else{var n=Math.round(e/a),i=Math.round(a/r*100);n||(n=0),i||(i=0);var s=o._getPercent(f,g,n),c=o._getColor(s);s<2&&(s=2),t(this).attr("data-value",e),t(".mtr-tactic .mtr-meter-fill",this).css("background",c.background).css("color",c.foreground).css("width",s+"%"),t(".mtr-tactic .mtr-stat",this).css("background",c.background).css("color",c.foreground).css("border-color",c.foreground),t(".mtr-tactic .mtr-total .mtr-stats-val",this).text(e.toLocaleString()),t(".mtr-tactic .mtr-count .mtr-stats-val",this).text(a.toLocaleString()+" (".concat(i,"%)")),t(".mtr-tactic .mtr-mean .mtr-stats-val",this).text(n.toLocaleString())}})),t(".mtr-technique, .mtr-sub-technique, .mtr-tactic",M).each((function(){t(this).click((function(e){var a=t(this).closest(".mtr-tactic-col"),r=t(this).closest(".mtr-technique-container"),n=t(".mtr-technique",r),i=t(this).closest(".mtr-sub-technique"),s={};s["mtr_sub-technique_id"]=i.attr("data-id"),s.mtr_technique_id=n.attr("data-id"),s.mtr_tactic_id=a.attr("data-id"),s["mtr_sub-technique_name"]=i.attr("data-name"),s.mtr_technique_name=n.attr("data-name"),s.mtr_tactic_name=a.attr("data-name"),s["mtr_sub-technique_value"]=i.attr("data-value"),s.mtr_technique_value=n.attr("data-value"),s.mtr_tactic_value=a.attr("data-value"),o._drilldown(s,e)}))})),t(".mtr-technique-col",M).each((function(){o._sortElements(t(this),_,y),t(this).append('\n                <div class="mtr-technique-container mtr-placeholder mtr-display-'.concat(b,'">\n                    <div class="mtr-technique mtr-display-').concat(b,'">\n                        <div class="mtr-technique-title">T0000</div>\n                    </div>\n                </div>\n                <div class="mtr-technique-container mtr-placeholder mtr-display-').concat(b,'">\n                    <div class="mtr-technique mtr-placeholder mtr-display-').concat(b,'">\n                        <div class="mtr-technique-title">T0000</div>\n                    </div>\n                </div>\n            '))})),C&&(t("input",P).on("change",(function(){(value=r.escapeHtml(this.value).toLowerCase(),""==value||null==value)?t(".mtr-technique",M).removeClass("focused").removeClass("defocused"):(t(".mtr-technique",M).removeClass("focused").addClass("defocused"),t(".mtr-technique",M).filter((function(){var e,a,r=null===(e=t(this).attr("data-id"))||void 0===e?void 0:e.toLowerCase(),n=null===(a=t(this).attr("data-name"))||void 0===a?void 0:a.toLowerCase();return(null==r?void 0:r.indexOf(value))>-1||(null==n?void 0:n.indexOf(value))>-1})).removeClass("defocused").addClass("focused"))})),P.appendTo(this.$el)),M.appendTo(this.$el),V.appendTo(this.$el),o.animate){var A=(g-f)/m/60,E=.1*(g-f),S=0;window.requestAnimationFrame((function e(){var a=S,r=a+A+E;o._setAnimationClass(a,r),a<g?S+=A:S=0,o.animate?window.requestAnimationFrame(e):t(".mtr-technique").removeClass("focused").removeClass("defocused")}))}}},getInitialDataParams:function(){return{outputMode:a.ROW_MAJOR_OUTPUT_MODE}},reflow:function(){},_setAnimationClass:function(e,a){t(".mtr-technique").each((function(){var r=t(this).attr("data-value");r&&r>=e&&r<=a?t(this).addClass("focused").removeClass("defocused"):t(this).removeClass("focused").addClass("defocused")}))},_getPercent:function(t,e,a){var r=Math.round(100*(a-t)/(e-t));return r>100&&(r=100),r<0&&(r=0),r},_hexToRgb:function(t){var e=0,a=0,r=0;return 4==t.length?(e="0x"+t[1]+t[1],a="0x"+t[2]+t[2],r="0x"+t[3]+t[3]):7==t.length&&(e="0x"+t[1]+t[2],a="0x"+t[3]+t[4],r="0x"+t[5]+t[6]),{r:e,g:a,b:r}},_getColor:function(t){for(var e=1;e<this.colorMap.length-1&&!(t<this.colorMap[e].pct);e++);var a=this.colorMap[e-1],r=this.colorMap[e],n=r.pct-a.pct,i=(t-a.pct)/n,s=1-i,c=i,o={r:Math.floor(a.color.r*s+r.color.r*c),g:Math.floor(a.color.g*s+r.color.g*c),b:Math.floor(a.color.b*s+r.color.b*c)},l=(.299*o.r+.587*o.g+.114*o.b)/255,d=l>.65?"rgb(0,0,0)":"rgb(255,255,255)";return{background:"rgb("+[o.r,o.g,o.b].join(",")+")",luminance:l,foreground:d}},_sortElements:function(e,a,r){var n="asc"==r?1:-1;$children=e.children().sort((function(e,r){var i=t(".mtr-technique",t(e)),s=t(".mtr-technique",t(r));return"data-id"==a||"data-name"==a?n*(i.attr(a)<s.attr(a)?-1:1):"data-value"==a?(aVal=parseInt(i.attr(a)),bVal=parseInt(s.attr(a)),Number.isInteger(aVal)||(aVal=-1),Number.isInteger(bVal)||(bVal=-1),n*(aVal<bVal?-1:1)):0})),e.append($children)},_drilldown:function(t,e){this.drilldown({action:a.FIELD_VALUE_DRILLDOWN,data:t},e)}})}));